services:
  # NOTE: PostgreSQL and Redis are now provided by STORION/UNION
  # Remove local postgres/redis services and use external networks
  # Database: STORION PostgreSQL (msqdx-unison-postgres-1:5432/storion)
  # Redis: UNION Redis (msqdx-unison-redis-1:6379)

  # Backend Service
  backend:
    build:
      context: ./packages/backend
      dockerfile: Dockerfile
    container_name: videon-backend
    environment:
      NODE_ENV: production
      PORT: 4001
      # STORION Database (with videon schema)
      USE_STORION_DB: ${USE_STORION_DB:-true}
      STORION_DATABASE_URL: ${STORION_DATABASE_URL:-postgresql+psycopg://unison:unison@msqdx-unison-postgres-1:5432/storion}
      # DATABASE_URL must use container name, not localhost, and postgresql:// (not postgresql+psycopg://) for Prisma
      DATABASE_URL: postgresql://unison:unison@msqdx-unison-postgres-1:5432/storion?schema=videon
      # Note: Container name (msqdx-unison-postgres-1) must be used in Docker, not localhost
      # UNION Redis
      REDIS_URL: ${REDIS_URL:-redis://msqdx-unison-redis-1:6379/0}
      # STORION Storage
      STORION_STORAGE_URL: ${STORION_STORAGE_URL:-http://storion:8003}
      STORION_BASE_URL: ${STORION_BASE_URL:-http://storion:8003}
      # UNION Integration
      UNION_BASE_URL: ${UNION_BASE_URL:-http://msqdx-unison-unison-1:8000}
      UNION_SETTINGS_ENABLED: ${UNION_SETTINGS_ENABLED:-true}
      UNION_SETTINGS_CACHE_TTL: ${UNION_SETTINGS_CACHE_TTL:-900}
      # Other services
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-dummy-key-for-development}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}
      ANALYZER_SERVICE_URL: http://analyzer:8001
      AUDIO_SEPARATION_SERVICE_URL: http://audio-separation-service:8003
      AUDIO_SERVICE_URL: http://audio-service:5679
      SALIENCY_SERVICE_URL: http://saliency-service:8002
      VISION_SERVICE_URL: http://vision-service:8004
      QWEN_VL_SERVICE_URL: http://host.docker.internal:8081
      CORS_ORIGINS: http://localhost:3010,http://192.168.50.101:3010
      # Local storage fallback (if not using STORION)
      VIDEOS_STORAGE_PATH: /app/storage/videos
      KEYFRAMES_STORAGE_PATH: /app/storage/keyframes
      AUDIO_STEMS_STORAGE_PATH: /app/storage/audio_stems
      THUMBNAILS_STORAGE_PATH: /app/storage/thumbnails
      HOST_STORAGE_PATH: /Users/m4-dev/Development/videon/storage
    ports:
      - "0.0.0.0:4001:4001"
    volumes:
      - ./storage:/app/storage
      - ./packages/backend/prisma:/app/prisma
    networks:
      - videon-network
      - ion-network
      - echon-network
    restart: unless-stopped
    command: npm start

  # Qwen VL Service runs LOCALLY (not in Docker)
  # MLX requires Apple Silicon and cannot run in Docker containers.
  # Start it manually with: cd packages/qwen-vl-service && ./start.sh
  # It will be accessible at http://localhost:8081
  # Backend accesses it via host.docker.internal:8081

  # Frontend Service
  frontend:
    build:
      context: ./packages
      dockerfile: frontend/Dockerfile
      args:
        PUBLIC_BACKEND_URL: ${PUBLIC_BACKEND_URL:-http://192.168.50.101:4001}
    container_name: videon-frontend
    environment:
      NODE_ENV: production
      PUBLIC_BACKEND_URL: http://192.168.50.101:4001
    ports:
      - "0.0.0.0:3010:3003"
    networks:
      - videon-network
    depends_on:
      - backend
    restart: unless-stopped

  # Analyzer Service
  analyzer:
    build:
      context: ./packages/analyzer
      dockerfile: Dockerfile
    container_name: videon-analyzer
    environment:
      PYTHONPATH: /app/src
      # STORION Database
      USE_STORION_DB: ${USE_STORION_DB:-true}
      STORION_DATABASE_URL: ${STORION_DATABASE_URL:-postgresql+psycopg://unison:unison@msqdx-unison-postgres-1:5432/storion}
      # DATABASE_URL for Python services (psycopg2 doesn't support ?schema=, use search_path instead)
      DATABASE_URL: postgresql://unison:unison@msqdx-unison-postgres-1:5432/storion
      STORAGE_PATH: /app/storage
      BACKEND_URL: http://backend:4001
      VISION_SERVICE_URL: http://host.docker.internal:8080
    ports:
      - "0.0.0.0:8004:8001"
    volumes:
      - ./storage:/app/storage
    networks:
      - videon-network
      - ion-network
      - echon-network
    restart: unless-stopped

  # Saliency Service
  saliency-service:
    build:
      context: ./packages/saliency-service
      dockerfile: Dockerfile
    container_name: videon-saliency-service
    environment:
      PYTHONPATH: /app/src
      LOG_LEVEL: INFO
      BACKEND_URL: http://backend:4001
      # STORION Database
      USE_STORION_DB: ${USE_STORION_DB:-true}
      STORION_DATABASE_URL: ${STORION_DATABASE_URL:-postgresql+psycopg://unison:unison@msqdx-unison-postgres-1:5432/storion}
      # DATABASE_URL for Python services (psycopg2 doesn't support ?schema=, use search_path instead)
      DATABASE_URL: postgresql://unison:unison@msqdx-unison-postgres-1:5432/storion
    ports:
      - "0.0.0.0:8005:8002"
    volumes:
      - ./storage:/app/storage
      - ./packages/saliency-service/models:/app/models
    networks:
      - videon-network
      - ion-network
      - echon-network
    depends_on:
      backend:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Audio Separation Service
  audio-separation-service:
    build:
      context: .
      dockerfile: packages/audio-separation-service/Dockerfile
    container_name: videon-audio-separation-service
    environment:
      PYTHONPATH: /app/src
      # STORION Database
      USE_STORION_DB: ${USE_STORION_DB:-true}
      STORION_DATABASE_URL: ${STORION_DATABASE_URL:-postgresql+psycopg://unison:unison@msqdx-unison-postgres-1:5432/storion}
      # DATABASE_URL for Python services (psycopg2 doesn't support ?schema=, use search_path instead)
      DATABASE_URL: postgresql://unison:unison@msqdx-unison-postgres-1:5432/storion
      ANALYZER_SERVICE_URL: http://analyzer:8001
      STORAGE_PATH: /app/storage
    ports:
      - "0.0.0.0:8006:8003"
    volumes:
      - ./storage:/app/storage
    networks:
      - videon-network
      - ion-network
      - echon-network
    depends_on:
      analyzer:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8003/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Audio Service
  audio-service:
    build:
      context: .
      dockerfile: packages/audio-service/Dockerfile
    container_name: videon-audio-service
    environment:
      PYTHONPATH: /app/src
      # STORION Database
      USE_STORION_DB: ${USE_STORION_DB:-true}
      STORION_DATABASE_URL: ${STORION_DATABASE_URL:-postgresql+psycopg://unison:unison@msqdx-unison-postgres-1:5432/storion}
      # DATABASE_URL for Python services (psycopg2 doesn't support ?schema=, use search_path instead)
      DATABASE_URL: postgresql://unison:unison@msqdx-unison-postgres-1:5432/storion
      STORAGE_PATH: /app/storage
    ports:
      - "0.0.0.0:5680:5679"
    volumes:
      - ./storage:/app/storage
    networks:
      - videon-network
      - ion-network
      - echon-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5679/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Storybook Service - Development Container
  storybook:
    build:
      context: ./packages/frontend
      dockerfile: Dockerfile.storybook
    container_name: videon-storybook
    environment:
      NODE_ENV: development
    ports:
      - "0.0.0.0:6006:6006"
    volumes:
      # Mount source for hot reload
      - ./packages/frontend/src:/app/src
      - ./packages/frontend/.storybook:/app/.storybook
      - ./packages/frontend/svelte.config.js:/app/svelte.config.js
      - ./packages/frontend/vite.config.ts:/app/vite.config.ts
      - ./packages/frontend/tsconfig.json:/app/tsconfig.json
      - ./packages/frontend/postcss.config.js:/app/postcss.config.js
      - ./packages/frontend/tailwind.config.js:/app/tailwind.config.js
      # Create .svelte-kit directory with dummy tsconfig for Vite
      - videon_storybook_sveltekit_config:/app/.svelte-kit
      # Exclude node_modules from mount (use container's)
      - /app/node_modules
    networks:
      - videon-network
    restart: unless-stopped
    # Development mode - no healthcheck needed
    stdin_open: true
    tty: true

volumes:
  videon_storybook_sveltekit_config:
    # NOTE: postgres_data and redis_data removed - using STORION/UNION

networks:
  videon-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.30.0.0/16
  # External networks for STORION/UNION integration
  ion-network:
    name: ion-network
    external: true
  echon-network:
    name: echon-network
    external: true
